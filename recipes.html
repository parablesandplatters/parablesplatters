<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Recipes & Message Board — Pro Mobile</title>
  <link rel="icon" href="01. images/jesuslogo_enef.png" type="image/x-icon">
  <meta name="description" content="Mobile-optimized Recipes and Team Message Board with realtime Firestore backend" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Mobile-first responsive design, accessible sizes and reduced motion supported */
    :root{
      --bg:#ffffff; --text:#0b0b0b; --muted:#666; --card:#f7efe6; --accent:#e3c5a3;
      --primary:#ff7b4b; --primary-hover:#ff4927; --radius:12px; --gap:12px; --shadow:0 6px 18px rgba(8,8,8,0.08);
    }
    [data-theme="dark"]{ --bg:#0b0b0b; --text:#f2f2f2; --muted:#a8a8a8; --card:#221d18; --accent:#3e2f1c; --primary:#ffa07a; --primary-hover:#e76f51; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Roboto, system-ui, -apple-system, 'Segoe UI', Arial; background:var(--bg); color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; padding-bottom:96px; transition:background .25s, color .25s;
    }
    header{position:sticky; top:0; background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85)); backdrop-filter: blur(6px); z-index:1200; border-bottom:1px solid rgba(0,0,0,0.06)}
    header .wrap{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; max-width:1100px; margin:0 auto}
    h1{font-size:18px; margin:0}
    .controls{display:flex; gap:8px; align-items:center}
    .theme-toggle{background:transparent; border:none; font-size:20px; line-height:1; padding:8px; border-radius:8px}
    main{max-width:1100px; margin:18px auto; padding:0 16px}

    /* form + controls */
    .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); margin-bottom:var(--gap)}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input[type=text], textarea, select{width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(0,0,0,0.08); background:transparent; color:var(--text); font-size:15px}
    textarea{min-height:96px; resize:vertical}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:12px 14px; border-radius:12px; background:var(--primary); color:#000; border:none; font-weight:600; font-size:15px}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent; border:1px solid rgba(0,0,0,0.08); color:var(--text)}

    /* recipes grid */
    #recipesControls{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0 0}
    #recipesContainer{display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px}
    @media(min-width:720px){ #recipesContainer{grid-template-columns:repeat(2, 1fr)} }
    @media(min-width:1000px){ #recipesContainer{grid-template-columns:repeat(3, 1fr)} }

    .recipe-card{background:var(--bg); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(2,2,2,0.06); border:1px solid rgba(0,0,0,0.04); display:flex; flex-direction:column}
    .recipe-header{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .recipe-title{font-size:16px; font-weight:700}
    .recipe-meta{font-size:12px; color:var(--muted)}
    .recipe-preview{margin-top:8px; font-size:14px; color:var(--muted); white-space:pre-wrap}

    .recipe-content{overflow:hidden; max-height:0; transition:max-height .35s ease}
    .recipe-content.open{max-height:720px}
    .steps{margin:8px 0 0; padding-left:18px}
    .card-actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}

    /* message board */
    #messageBoard{display:flex; flex-direction:column; gap:8px}
    .message{background:var(--card); padding:10px; border-radius:10px; box-shadow:var(--shadow)}
    .message strong{display:block}
    .message small{color:var(--muted); display:block; margin-top:8px; font-size:12px}

    /* toast */
    #toast{position:fixed; left:50%; transform:translateX(-50%); bottom:96px; background:rgba(0,0,0,0.85); color:#fff; padding:12px 16px; border-radius:12px; opacity:0; pointer-events:none; transition:opacity .25s}

    /* usability */
    button, .btn, input, textarea, select{touch-action:manipulation}
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}

    /* accessibility: respect prefers-reduced-motion */
    @media (prefers-reduced-motion: reduce){ *{transition:none!important} }
  </style>
</head>

<body data-theme="light">
  <header>
    <div class="wrap">
      <h1>Recipes & Message Board — Pro Mobile</h1>
      <div class="controls">
        <button class="theme-toggle" id="themeBtn" aria-label="Toggle theme">🌙</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Recipes Card -->
    <section class="card" aria-labelledby="recipesHeading">
      <h2 id="recipesHeading" style="margin:0 0 8px;font-size:16px">Add / Manage Recipes</h2>

      <label for="recipeCodename">Your codename (saved locally)</label>
      <input id="recipeCodename" type="text" inputmode="text" placeholder="e.g. AirCav" autocomplete="name" />

      <label for="newTitle">Recipe Title</label>
      <input id="newTitle" type="text" placeholder="Chicken Stew" />

      <label for="newInstructions">Instructions — one step per line</label>
      <textarea id="newInstructions" placeholder="1. Chop onions
2. ..."></textarea>

      <div style="display:flex;gap:8px; margin-top:10px">
        <button class="btn" id="addRecipeBtn">Add Recipe</button>
        <button class="btn secondary" id="clearFormBtn">Clear</button>
      </div>

      <div id="recipesControls" style="margin-top:12px">
        <input id="searchBox" type="text" placeholder="Search title or instructions" aria-label="Search recipes" style="min-width:140px;flex:1" />
        <select id="sortSelect" aria-label="Sort recipes">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="az">Title A→Z</option>
          <option value="za">Title Z→A</option>
        </select>
        <label style="display:flex;align-items:center;gap:6px"><input id="showMine" type="checkbox" /> My recipes</label>
        <button class="btn secondary" id="refreshBtn">Refresh</button>
      </div>

    </section>

    <!-- Recipes list -->
    <section id="recipesContainer" aria-live="polite" aria-label="Recipes list" class="card" style="padding:12px">
      <p id="loadingMessage">Loading recipes…</p>
    </section>

    <!-- Message Board Card -->
    <section class="card" aria-labelledby="messagesHeading">
      <h2 id="messagesHeading" style="margin:0 0 8px;font-size:16px">Team Message Board</h2>
      <label for="codenameInput">Codename</label>
      <input id="codenameInput" type="text" placeholder="Your codename" />
      <label for="messageInput">Message</label>
      <textarea id="messageInput" placeholder="Write a friendly message…"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="postMessageBtn">Post Message</button>
        <button class="btn secondary" id="clearMsgBtn">Clear</button>
      </div>
    </section>

    <section id="messageBoard" aria-live="polite" class="card" style="padding:12px">
      <p id="loadingMessages">Loading messages…</p>
    </section>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js';
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, orderBy, query, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBoc_mvc4WpduIYYUvLnA3iu46NvweFiLQ",
      authDomain: "recipes-1b0d1.firebaseapp.com",
      projectId: "recipes-1b0d1",
      storageBucket: "recipes-1b0d1.appspot.com",
      messagingSenderId: "15200297908",
      appId: "1:15200297908:web:45cdc1cdee6ce211d788e1"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Utilities
    const $ = id => document.getElementById(id);
    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;" })[c]); }
    function showToast(msg, ms=2500){ const t=$('toast'); t.textContent=msg; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, ms); }

    // Save codename locally
    const recipeCodename = $('recipeCodename'); const saved = localStorage.getItem('my_codename'); if(saved) recipeCodename.value = saved;
    recipeCodename.addEventListener('change', ()=>localStorage.setItem('my_codename', recipeCodename.value.trim()));

    // ---------------- RECIPES ----------------
    const recipesRef = collection(db, 'recipes');

    async function addRecipe(){
      const title = $('newTitle').value.trim();
      const instructions = $('newInstructions').value.trim().split('
').map(s=>s.trim()).filter(Boolean);
      const owner = recipeCodename.value.trim() || null;
      if(!title || !instructions.length) return showToast('Please enter title and at least one step.');
      try{
        await addDoc(recipesRef, { title, instructions, owner, createdAt: serverTimestamp() });
        $('newTitle').value=''; $('newInstructions').value=''; showToast('Recipe added');
      }catch(e){ console.error(e); showToast('Could not add recipe'); }
    }

    // Lightweight in-memory cache for docs to avoid re-render thrash on mobile
    let recipesCache = []; // [{id, data}]

    // Render helpers
    function makeRecipeElement(docId, data){
      const el = document.createElement('article'); el.className='recipe-card'; el.tabIndex=0; el.setAttribute('role','article');
      const title = escapeHtml(data.title || 'Untitled');
      const owner = escapeHtml(data.owner || '');
      const steps = Array.isArray(data.instructions) ? data.instructions : [];
      const created = data.createdAt && typeof data.createdAt.toDate==='function' ? data.createdAt.toDate().toLocaleString() : '';

      el.innerHTML = `
        <div class="recipe-header">
          <div>
            <div class="recipe-title">${title}</div>
            <div class="recipe-meta">${owner ? 'by '+owner+' • ' : ''}${created}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
            <button class="btn secondary" data-action="toggle">Expand</button>
            <div style="font-size:12px;color:var(--muted)">${steps.length} step${steps.length===1?'':'s'}</div>
          </div>
        </div>
        <div class="recipe-content" aria-hidden="true">
          <ol class="steps">${steps.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ol>
          <div class="card-actions">
            <button class="btn" data-action="edit">Edit</button>
            <button class="btn secondary" data-action="delete">Delete</button>
          </div>
        </div>
      `;

      // event delegation for card
      el.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button');
        if(btn){
          const action = btn.getAttribute('data-action');
          if(action==='toggle') toggleCard(el);
          else if(action==='edit') { ev.stopPropagation(); startEdit(docId, data, el); }
          else if(action==='delete') { ev.stopPropagation(); removeRecipe(docId); }
        }else{
          // toggle on card tap
          toggleCard(el);
        }
      });
      return el;
    }

    function toggleCard(el){ const content = el.querySelector('.recipe-content'); const open = content.classList.toggle('open'); content.setAttribute('aria-hidden', !open); }

    async function removeRecipe(id){ if(!confirm('Delete recipe?')) return; try{ await deleteDoc(doc(db,'recipes',id)); showToast('Deleted'); }catch(e){console.error(e); showToast('Could not delete');} }

    function startEdit(id, data, el){
      const content = el.querySelector('.recipe-content'); content.classList.add('open'); content.setAttribute('aria-hidden', 'false');
      const stepsText = (Array.isArray(data.instructions)?data.instructions:[]).join('
');
      content.innerHTML = `
        <label class="visually-hidden">Edit title</label>
        <input type="text" id="editTitle-${id}" value="${escapeHtml(data.title||'')}" />
        <label class="visually-hidden">Edit steps</label>
        <textarea id="editInstructions-${id}" style="margin-top:8px">${escapeHtml(stepsText)}</textarea>
        <label class="visually-hidden">Edit owner</label>
        <input type="text" id="editOwner-${id}" placeholder="Owner (optional)" value="${escapeHtml(data.owner||'')}" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="save-${id}">Save</button>
          <button class="btn secondary" id="cancel-${id}">Cancel</button>
        </div>
      `;
      content.querySelector(`#save-${id}`).addEventListener('click', async ()=>{
        const title = $(`editTitle-${id}`).value.trim();
        const instructions = $(`editInstructions-${id}`).value.trim().split('
').map(s=>s.trim()).filter(Boolean);
        const owner = $(`editOwner-${id}`).value.trim() || null;
        if(!title || !instructions.length) return showToast('Please complete fields');
        try{ await updateDoc(doc(db,'recipes',id), { title, instructions, owner }); showToast('Saved'); }
        catch(e){ console.error(e); showToast('Could not save'); }
      });
      content.querySelector(`#cancel-${id}`).addEventListener('click', ()=>{ renderRecipesFromCache(); });
    }

    // Render from recipesCache with pagination (mobile friendly): show initial N items
    let PAGE_SIZE = 12; let currentPage = 1;
    function renderRecipesFromCache(){
      const container = $('recipesContainer'); container.innerHTML='';
      const start = 0; const end = PAGE_SIZE * currentPage;
      const filtered = applyClientFilters(recipesCache);
      const slice = filtered.slice(start, end);
      if(!slice.length) container.innerHTML = '<p>No recipes found.</p>';
      else slice.forEach(d=>container.appendChild(makeRecipeElement(d.id, d.data)));

      // show load more if more
      const total = filtered.length;
      if(end < total){
        const more = document.createElement('div'); more.style.textAlign='center'; more.style.marginTop='8px';
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Load more';
        btn.addEventListener('click', ()=>{ currentPage++; renderRecipesFromCache(); window.scrollBy({top:200, behavior:'smooth'}); });
        more.appendChild(btn); container.appendChild(more);
      }
    }

    function applyClientFilters(list){
      const q = $('searchBox').value.trim().toLowerCase(); const showMine = $('showMine').checked; const my = (localStorage.getItem('my_codename')||'').toLowerCase();
      let filtered = list.filter(d=>{
        const title = (d.data.title||'').toLowerCase(); const ins = (Array.isArray(d.data.instructions)?d.data.instructions.join(' '):'').toLowerCase();
        return (!q || title.includes(q) || ins.includes(q)) && (!showMine || ((d.data.owner||'').toLowerCase() === my));
      });
      const sortVal = $('sortSelect').value;
      filtered.sort((a,b)=>{
        if(sortVal==='az') return (a.data.title||'').localeCompare(b.data.title||'');
        if(sortVal==='za') return (b.data.title||'').localeCompare(a.data.title||'');
        const aT = a.data.createdAt && a.data.createdAt.toMillis ? a.data.createdAt.toMillis() : 0;
        const bT = b.data.createdAt && b.data.createdAt.toMillis ? b.data.createdAt.toMillis() : 0;
        return sortVal==='oldest' ? aT - bT : bT - aT;
      });
      return filtered;
    }

    // Debounce helper for search
    function debounce(fn, wait=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

    // Firestore listener -- keep cache up to date, but throttle UI renders for mobile
    function subscribeRecipes(){
      try{
        const q = query(recipesRef, orderBy('createdAt','desc'));
        onSnapshot(q, snap=>{ const docs=[]; snap.forEach(s=>docs.push({id:s.id,data:s.data()})); recipesCache = docs; currentPage=1; renderRecipesFromCache(); }, err=>{ console.warn('ordered snapshot failed',err); onSnapshot(recipesRef, snap=>{ const docs=[]; snap.forEach(s=>docs.push({id:s.id,data:s.data()})); recipesCache = docs; currentPage=1; renderRecipesFromCache(); }); });
      }catch(e){ console.warn('subscribe fallback', e); onSnapshot(recipesRef, snap=>{ const docs=[]; snap.forEach(s=>docs.push({id:s.id,data:s.data()})); recipesCache = docs; currentPage=1; renderRecipesFromCache(); }); }
    }

    // ---------------- MESSAGES ----------------
    const messagesRef = collection(db, 'messages');

    async function postMessage(){
      const codename = $('codenameInput').value.trim(); const message = $('messageInput').value.trim();
      if(!codename || !message) return showToast('Please enter codename & message');
      try{ await addDoc(messagesRef, { codename, message, timestamp: serverTimestamp() }); $('messageInput').value=''; showToast('Posted'); }
      catch(e){ console.error(e); showToast('Could not post'); }
    }

    function renderMessages(snapshot){ const container = $('messageBoard'); container.innerHTML=''; if(snapshot.empty){ container.innerHTML='<p>No messages yet.</p>'; return;} snapshot.forEach(s=>{ const d=s.data(); const div=document.createElement('div'); div.className='message'; const ts = d.timestamp && d.timestamp.toDate ? d.timestamp.toDate().toLocaleString():''; div.innerHTML=`<strong>${escapeHtml(d.codename||'Anon')}</strong><div style="white-space:pre-wrap">${escapeHtml(d.message||'')}</div><small>${escapeHtml(ts)}</small>`; container.appendChild(div); }); container.scrollTop = 0; }

    function subscribeMessages(){ try{ const q = query(messagesRef, orderBy('timestamp','desc')); onSnapshot(q, snap=>renderMessages(snap)); }catch(e){ onSnapshot(messagesRef, snap=>renderMessages(snap)); } }

    // ---------------- Init & events ----------------
    window.addEventListener('DOMContentLoaded', ()=>{
      $('addRecipeBtn').addEventListener('click', addRecipe);
      $('postMessageBtn').addEventListener('click', postMessage);
      $('clearFormBtn').addEventListener('click', ()=>{ $('newTitle').value=''; $('newInstructions').value=''; });
      $('clearMsgBtn').addEventListener('click', ()=>{ $('codenameInput').value=''; $('messageInput').value=''; });
      $('refreshBtn').addEventListener('click', ()=>{ renderRecipesFromCache(); showToast('Refreshed'); });
      $('searchBox').addEventListener('input', debounce(()=>{ currentPage=1; renderRecipesFromCache(); }, 250));
      $('sortSelect').addEventListener('change', debounce(()=>{ currentPage=1; renderRecipesFromCache(); }, 150));
      $('showMine').addEventListener('change', debounce(()=>{ currentPage=1; renderRecipesFromCache(); }, 150));

      // theme toggle persisted
      const themeBtn = $('themeBtn'); const savedTheme = localStorage.getItem('theme'); if(savedTheme) document.body.setAttribute('data-theme', savedTheme);
      themeBtn.addEventListener('click', ()=>{ const cur = document.body.getAttribute('data-theme')==='light' ? 'dark' : 'light'; document.body.setAttribute('data-theme', cur); localStorage.setItem('theme', cur); themeBtn.textContent = cur==='light' ? '🌙' : '☀️'; });

      // prefill message codename
      const s = localStorage.getItem('my_codename'); if(s) $('codenameInput').value = s;
      $('codenameInput').addEventListener('change', (e)=>localStorage.setItem('my_codename', e.target.value.trim()));

      // subscribe
      subscribeRecipes(); subscribeMessages();

      // accessibility: focus outlines
      document.body.addEventListener('keyup', (e)=>{ if(e.key==='Tab') document.body.classList.add('show-focus'); });
    });

    // small helper for getElement by id with backticks in startEdit
    function $(id){ return document.getElementById(id); }
  </script>
</body>
</html>
















